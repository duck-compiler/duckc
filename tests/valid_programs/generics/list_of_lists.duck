use go "fmt";

struct List<T> = {
    elems: T[],
} impl {
    mut fn push(e: T) {
        go {
            (*self).elems = append((*self).elems, e)
        }
    }

    fn map<U>(f: fn(v: T) -> U) -> List<U> {
        let res: List<U> = List<U> { elems: [] as U[] };
        go {
            for _, e := range (*self).elems {
                (*res).elems = append(res.elems, f(e))
            }
        }
        return res;
    }

    fn empty_copy() -> List<T> {
        return List<T> {
            elems: [] as T[],
        };
    }

};

struct X<E> = {
    a: E,
} impl {
    fn give_me_a_list() -> List<E> {
        let res: List<E> = List<E> { elems: [] as E[] };
        res.map<E>(fn(v: E) -> E { return v; });
        return res;
    }
};

fn print_with_go(x: {}) {
    go {
        fmt.Println(x)
    }
}

type StringList = List<String>;
type ArrayList<T> = List<T>;
type AryList<L> = List<L>;

fn main() {
    let inst: X<Float> = X<Float> {a: 1.0};
    print_with_go(inst.give_me_a_list());

    let list: List<String> = List<String> { elems: [] as String[] };
    let other: StringList = list;
    print_with_go(other.map<Int>(fn (v: String) -> Int { return 200 }));

    let other2: ArrayList<String> = list;
    print_with_go(other2.map<Int>(fn (v: String) -> Int { return 200 }));

    let other3: AryList<String> = list;
    print_with_go(other3.map<Int>(fn (v: String) -> Int { return 200 }));

    list.push("yo");
    list.push("moin");

    print_with_go(
        list.map<Int>(fn(v: String) -> Int { return 100; })
            .map<String>(fn (v: Int) -> String { return "yooo"; })
    );
    print_with_go(list.map<Float>(fn(v: String) -> Float { return 100.0 }));
    print_with_go(list.map<Bool>(fn(v: String) -> Bool { return true }));
    print_with_go(list.map<String>(fn(v: String) -> String { return "" }));
    let list_of_lists_with_map: List<List<String>> = list.map<List<String>>(fn(v: String) -> List<String> { return List<String> { elems: ["yo", "servus"] } });
    let list_of_list_of_lists_with_map: List<List<List<String>>> = list.map<List<List<String>>>(fn(v: String) -> List<List<String>> { return List<List<String>> { elems: [ List<String> { elems: ["a", "b", "c"] }, List<String> { elems: ["100"] } ] } });

    print_with_go(list);

    let list_of_list: List<List<String>> = List<List<String>> { elems: [] as List<String>[] };
    list_of_list.push(List<String> {
        elems: ["ich", "bin", "liste", "1"],
    });
    list_of_list.push(list);

    go {
        for i := range list_of_list.elems {
            fmt.Println("list at index", i, list_of_list.elems[i])
        }

        fmt.Println()

        for i := range list_of_lists_with_map.elems {
            fmt.Println("list at index", i, list_of_lists_with_map.elems[i])
        }

        fmt.Println()

        for i := range list_of_list_of_lists_with_map.elems {
            for j := range list_of_list_of_lists_with_map.elems[i].elems {
                fmt.Println("list at index", i, j, list_of_list_of_lists_with_map.elems[i].elems[j])
            }
        }
    }
}
